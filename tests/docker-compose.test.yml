# Docker Compose for agent-context tests
# Usage:
#   docker compose -f tests/docker-compose.test.yml build
#   docker compose -f tests/docker-compose.test.yml run smoke
#   docker compose -f tests/docker-compose.test.yml run local-git
#   docker compose -f tests/docker-compose.test.yml run e2e  # requires tokens

services:
  # Build base test image
  test-base:
    build:
      context: ..
      dockerfile: tests/Dockerfile.test
    image: agent-context-test:latest

  # Stage 0: Unit tests (structure validation)
  unit:
    image: agent-context-test:latest
    depends_on:
      test-base:
        condition: service_completed_successfully
    volumes:
      - unit-workspace:/workspace
    working_dir: /agent-context
    command: ["bash", "/agent-context/tests/unit/run-all-unit-tests.sh"]

  # Stage 1: Smoke tests (no remote, no tokens)
  smoke:
    image: agent-context-test:latest
    depends_on:
      test-base:
        condition: service_completed_successfully
    volumes:
      - smoke-workspace:/workspace
    working_dir: /agent-context
    command: ["bash", "/agent-context/tests/smoke/test_smoke.sh"]

  # Stage 2: Local Git tests (bare repo as remote)
  local-git:
    image: agent-context-test:latest
    depends_on:
      test-base:
        condition: service_completed_successfully
    volumes:
      - local-git-workspace:/workspace
    working_dir: /agent-context
    command: ["bash", "/agent-context/tests/local-git/test_local_git.sh"]

  # Stage 3: E2E tests (requires GitLab/JIRA tokens)
  e2e:
    image: agent-context-test:latest
    depends_on:
      test-base:
        condition: service_completed_successfully
    volumes:
      - e2e-workspace:/workspace
    working_dir: /agent-context
    environment:
      - GITLAB_API_TOKEN=${GITLAB_API_TOKEN:-}
      - GITLAB_URL=${GITLAB_URL:-}
      - GITLAB_TEST_PROJECT=${GITLAB_TEST_PROJECT:-}
      - JIRA_API_TOKEN=${JIRA_API_TOKEN:-}
      - JIRA_URL=${JIRA_URL:-}
      - JIRA_EMAIL=${JIRA_EMAIL:-}
      - JIRA_TEST_PROJECT=${JIRA_TEST_PROJECT:-}
    command: ["bash", "/agent-context/tests/e2e/test_e2e.sh"]

  # Scenario tests (runs 15 documented scenarios)
  scenario:
    image: agent-context-test:latest
    depends_on:
      test-base:
        condition: service_completed_successfully
    volumes:
      - scenario-workspace:/workspace
    working_dir: /agent-context
    environment:
      - GITLAB_API_TOKEN=${GITLAB_API_TOKEN:-}
      - GITLAB_URL=${GITLAB_URL:-}
      - GITLAB_TEST_PROJECT=${GITLAB_TEST_PROJECT:-}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - JIRA_API_TOKEN=${JIRA_API_TOKEN:-}
      - JIRA_URL=${JIRA_URL:-}
      - JIRA_EMAIL=${JIRA_EMAIL:-}
    command: ["bash", "/agent-context/tests/scenario/runner.sh", "--quick"]

  # Scenario tests (all 15 scenarios)
  scenario-full:
    image: agent-context-test:latest
    depends_on:
      test-base:
        condition: service_completed_successfully
    volumes:
      - scenario-full-workspace:/workspace
    working_dir: /agent-context
    environment:
      - GITLAB_API_TOKEN=${GITLAB_API_TOKEN:-}
      - GITLAB_URL=${GITLAB_URL:-}
      - GITLAB_TEST_PROJECT=${GITLAB_TEST_PROJECT:-}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - JIRA_API_TOKEN=${JIRA_API_TOKEN:-}
      - JIRA_URL=${JIRA_URL:-}
      - JIRA_EMAIL=${JIRA_EMAIL:-}
    command: ["bash", "/agent-context/tests/scenario/runner.sh", "--all"]

  # Error handling tests
  error-handling:
    image: agent-context-test:latest
    depends_on:
      test-base:
        condition: service_completed_successfully
    volumes:
      - error-handling-workspace:/workspace
    working_dir: /agent-context
    command: ["bash", "/agent-context/tests/integration/test_error_handling.sh"]

  # Run all tests (1-2 stages only, no tokens required)
  all:
    image: agent-context-test:latest
    depends_on:
      test-base:
        condition: service_completed_successfully
    volumes:
      - all-workspace:/workspace
    working_dir: /agent-context
    command: ["bash", "/agent-context/tests/run-tests.sh", "--stages=1,2"]

  # Meta-validation tests (framework self-validation)
  meta:
    image: agent-context-test:latest
    depends_on:
      test-base:
        condition: service_completed_successfully
    volumes:
      - meta-workspace:/workspace
    working_dir: /agent-context
    command: ["bash", "/agent-context/tests/meta/run-all-meta-tests.sh"]

  # Logging tests (no tokens required)
  logging:
    image: agent-context-test:latest
    depends_on:
      test-base:
        condition: service_completed_successfully
    volumes:
      - logging-workspace:/workspace
    working_dir: /agent-context
    command: ["bash", "/agent-context/tests/e2e/test_logging.sh"]

  # Logging tests with verbose output
  logging-verbose:
    image: agent-context-test:latest
    depends_on:
      test-base:
        condition: service_completed_successfully
    volumes:
      - logging-verbose-workspace:/workspace
    working_dir: /agent-context
    command: ["bash", "/agent-context/tests/e2e/test_logging.sh", "--verbose"]

volumes:
  unit-workspace:
  smoke-workspace:
  local-git-workspace:
  e2e-workspace:
  scenario-workspace:
  scenario-full-workspace:
  error-handling-workspace:
  all-workspace:
  meta-workspace:
  logging-workspace:
  logging-verbose-workspace: