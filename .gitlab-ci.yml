# GitLab CI/CD Configuration
# agent-context repository
#
# Linting: Uses pre-commit (same as local development)
# Testing: Docker-based integration tests
#
# Pipeline stages:
#   lint  - Code quality checks (pre-commit)
#   test  - Functional tests (smoke, install, docker, e2e)
#
---
stages:
  - lint
  - test

# =============================================================================
# Global Variables
# =============================================================================
variables:
  # Shared across all jobs
  DOCKER_TLS_CERTDIR: ""

# =============================================================================
# Job Templates
# =============================================================================

.docker-test:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - docker compose -f tests/docker-compose.test.yml build

.ubuntu-base:
  stage: test
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq git curl jq
    # Install yq
    - |
      ARCH=$(uname -m)
      case "$ARCH" in
        x86_64) YQ_BINARY="yq_linux_amd64" ;;
        aarch64|arm64) YQ_BINARY="yq_linux_arm64" ;;
      esac
      curl -sL -o /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/latest/download/${YQ_BINARY}"
      chmod +x /usr/local/bin/yq

.rules-mr-or-main:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# Lint Stage
# =============================================================================

lint:
  stage: lint
  image: python:3.11-slim
  before_script:
    - |
      # Shell executor runners may not have root access, so avoid apt-get here.
      # Ensure hadolint exists for the pre-commit hadolint hook.
      set -e
      set -o pipefail

      CI_BIN_DIR="${CI_PROJECT_DIR}/.ci/bin"
      mkdir -p "${CI_BIN_DIR}"
      export PATH="${CI_BIN_DIR}:${PATH}"

      if ! command -v hadolint >/dev/null 2>&1; then
      	python3 - <<-'PY'
      	import os
      	import platform
      	import stat
      	import urllib.request

      	ver = "v2.14.0"
      	arch = platform.machine().lower()
      	if arch in ("x86_64", "amd64"):
      	    bin_name = "hadolint-Linux-x86_64"
      	elif arch in ("aarch64", "arm64"):
      	    bin_name = "hadolint-Linux-aarch64"
      	else:
      	    raise SystemExit(f"[X] Unsupported architecture for hadolint: {arch}")

      	dst_dir = os.path.join(os.environ["CI_PROJECT_DIR"], ".ci", "bin")
      	os.makedirs(dst_dir, exist_ok=True)
      	dst = os.path.join(dst_dir, "hadolint")
      	url = f"https://github.com/hadolint/hadolint/releases/download/{ver}/{bin_name}"

      	print(f"[*] Downloading hadolint: {url}")
      	with urllib.request.urlopen(url) as r:
      	    data = r.read()
      	with open(dst, "wb") as f:
      	    f.write(data)
      	st = os.stat(dst)
      	os.chmod(dst, st.st_mode | stat.S_IXUSR | stat.S_IXGRP | stat.S_IXOTH)
      	print(f"[V] Installed hadolint to: {dst}")
      	PY
      fi
    - pip install pre-commit
  script:
    - pre-commit run --all-files --show-diff-on-failure
  rules:
    - !reference [.rules-mr-or-main, rules]

# =============================================================================
# Test Stage - Core Tests (Always Run on MR/main)
# =============================================================================

# Agent-context smoke tests (deps, auth, global, project)
# Fast, offline checks for PR validation
test:agent-smoke:
  extends: .ubuntu-base
  script:
    - mkdir -p ~/.secrets && chmod 700 ~/.secrets
    - ./bin/agent-context.sh tests smoke
  rules:
    - !reference [.rules-mr-or-main, rules]

# Unit tests: version, help, tests list
test:unit:
  extends: .ubuntu-base
  script:
    - |
      set -e
      echo "=== Unit Tests ==="
      ./bin/agent-context.sh --version 2>&1 | grep -qE '[0-9]+\.[0-9]+\.[0-9]+'
      echo "[V] version output valid"
      ./bin/agent-context.sh --help 2>&1 | grep -q "USAGE"
      echo "[V] help output valid"
      ./bin/agent-context.sh tests list 2>&1 | grep -q "deps"
      echo "[V] tests list valid"
      echo "Summary: total=3 passed=3 failed=0 warned=0 skipped=0"
  rules:
    - !reference [.rules-mr-or-main, rules]

# Non-interactive install regression test
# Ensures install --non-interactive doesn't break on PR changes
test:install-noninteractive:
  extends: .ubuntu-base
  script:
    - ./bin/agent-context.sh tests --tags installNonInteractive
  rules:
    - !reference [.rules-mr-or-main, rules]

# Workflow tests (Stage 0-2: unit, smoke, local-git)
# E2E tests (Stage 3) require API tokens and are run locally only
test:workflow:
  extends: .docker-test
  script:
    - docker compose -f tests/docker-compose.test.yml run unit
    - docker compose -f tests/docker-compose.test.yml run smoke
    - docker compose -f tests/docker-compose.test.yml run local-git
  rules:
    - !reference [.rules-mr-or-main, rules]

# =============================================================================
# Test Stage - Docker Install Tests (Cross-Platform)
# =============================================================================

# Docker-based installation test on Ubuntu
test:docker-install-ubuntu:
  extends: .docker-test
  script:
    - docker compose -f tests/docker-compose.test.yml run install-ubuntu
  rules:
    - !reference [.rules-mr-or-main, rules]
  artifacts:
    when: always
    paths:
      - tests/ci-results/
    expire_in: 7 days

# Docker-based installation test on UBI9 (RHEL)
test:docker-install-ubi9:
  extends: .docker-test
  script:
    - docker compose -f tests/docker-compose.test.yml run install-ubi9
  rules:
    - !reference [.rules-mr-or-main, rules]
  artifacts:
    when: always
    paths:
      - tests/ci-results/
    expire_in: 7 days

# =============================================================================
# Test Stage - Conditional Tests (Run on Specific Changes)
# =============================================================================

# Meta-validation tests (framework self-validation)
test:meta:
  extends: .docker-test
  script:
    - docker compose -f tests/docker-compose.test.yml run meta
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - .cursorrules
        - skills/**/*
        - workflows/**/*
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Error handling tests (no tokens required)
test:error-handling:
  extends: .docker-test
  script:
    - docker compose -f tests/docker-compose.test.yml run error-handling
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - tests/integration/**/*
        - tools/pm/**/*
        - tools/agent/**/*
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Scenario tests (quick mode, core scenarios only)
test:scenario:
  extends: .docker-test
  script:
    - docker compose -f tests/docker-compose.test.yml run scenario
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - tests/scenario/**/*
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true

# =============================================================================
# Test Stage - Demo Install Tests (via demo/install.sh)
# =============================================================================

# Full demo installation test on Ubuntu (offline, up to step 6)
test:demo-install-ubuntu:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    SKIP_E2E: "true"
  script:
    - |
      # Build and run demo installer in Docker
      ./demo/install.sh --os ubuntu --skip-e2e --only 6
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - install.sh
        - demo/**/*
        - bin/**/*
        - lib/**/*
        - builtin/**/*
        - templates/**/*
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  artifacts:
    when: always
    paths:
      - /tmp/agent-context-demo-*/
    expire_in: 7 days

# Full demo installation test on UBI9 (offline, up to step 6)
test:demo-install-ubi9:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    SKIP_E2E: "true"
  script:
    - |
      # Build and run demo installer in Docker
      ./demo/install.sh --os ubi9 --skip-e2e --only 6
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - install.sh
        - demo/**/*
        - bin/**/*
        - lib/**/*
        - builtin/**/*
        - templates/**/*
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  artifacts:
    when: always
    paths:
      - /tmp/agent-context-demo-*/
    expire_in: 7 days

# =============================================================================
# Test Stage - Manual/Scheduled Tests (Require Tokens)
# =============================================================================

# E2E tests (requires tokens, manual/scheduled only)
test:e2e:
  extends: .docker-test
  variables:
    DOCKER_TLS_CERTDIR: ""
    GITLAB_API_TOKEN: ${GITLAB_API_TOKEN}
    GITLAB_URL: ${GITLAB_URL}
    GITLAB_TEST_PROJECT: ${GITLAB_TEST_PROJECT}
    JIRA_API_TOKEN: ${JIRA_API_TOKEN}
    JIRA_URL: ${JIRA_URL}
    JIRA_EMAIL: ${JIRA_EMAIL}
    JIRA_TEST_PROJECT: ${JIRA_TEST_PROJECT}
  script:
    - docker compose -f tests/docker-compose.test.yml run e2e
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - when: manual
  allow_failure: true

# E2E demo with full install (requires tokens, manual only)
test:e2e-demo-full:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    JIRA_EMAIL: ${JIRA_EMAIL}
    JIRA_BASE_URL: ${JIRA_BASE_URL}
    JIRA_PROJECT_KEY: ${JIRA_PROJECT_KEY}
  script:
    - |
      # Run full E2E demo (ubuntu, serial)
      ./demo/run-docker-parallel.sh --serial
  rules:
    - when: manual
  allow_failure: true
  artifacts:
    when: always
    paths:
      - /tmp/agent-context-parallel-*/
    expire_in: 30 days

# Full scenario tests (all 15 scenarios, manual only)
test:scenario-full:
  extends: .docker-test
  variables:
    DOCKER_TLS_CERTDIR: ""
    GITLAB_API_TOKEN: ${GITLAB_API_TOKEN}
    GITLAB_URL: ${GITLAB_URL}
    GITHUB_TOKEN: ${GITHUB_TOKEN}
    JIRA_API_TOKEN: ${JIRA_API_TOKEN}
    JIRA_URL: ${JIRA_URL}
    JIRA_EMAIL: ${JIRA_EMAIL}
  script:
    - docker compose -f tests/docker-compose.test.yml run scenario-full
  rules:
    - when: manual
  allow_failure: true
