# GitLab CI/CD Configuration
# Coding Convention Test Framework for agent-context repository
#
# This project uses its own tools/lint/ci-templates/lint.yml template.
# Other projects can include this template via:
#
#   include:
#     - project: 'yourgroup/agent-context'
#       ref: main
#       file: '/tools/lint/ci-templates/lint.yml'
#
---
include:
  - local: 'tools/lint/ci-templates/lint.yml'

stages:
  - build
  - test
  - report

variables:
  # Override CONTEXT_DIR for self-testing (this repo is the context)
  CONTEXT_DIR: ${CI_PROJECT_DIR}
  # Nexus Docker Registry
  NEXUS_REGISTRY: nexus.soc-vnv.o:5000
  LINT_IMAGE: ${NEXUS_REGISTRY}/coding-convention-test:v1.0

# Build and push Docker image to Nexus (manual trigger only)
# Run this job when Dockerfile changes
build:image:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - cd tools/lint/tests
    - docker build -t ${LINT_IMAGE} .
    - docker push ${LINT_IMAGE}
  rules:
    # Manual trigger only - run when Dockerfile is updated
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - tools/lint/tests/Dockerfile
      when: manual
      allow_failure: true
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - tools/lint/tests/Dockerfile
      when: manual
      allow_failure: true
    # Allow manual trigger anytime
    - when: manual
      allow_failure: true

# All lint jobs (lint:c, lint:bash, lint:python, lint:make, lint:yaml)
# are automatically included via ci-templates/lint.yml
# They use the pre-built image from Nexus Registry

# Workflow tests (Stage 0-2: unit, smoke, local-git)
# E2E tests (Stage 3) require API tokens and are run locally only
test:workflow:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker compose -f tests/docker-compose.test.yml build
    - docker compose -f tests/docker-compose.test.yml run unit
    - docker compose -f tests/docker-compose.test.yml run smoke
    - docker compose -f tests/docker-compose.test.yml run local-git
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Meta-validation tests (framework self-validation)
test:meta:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker compose -f tests/docker-compose.test.yml build
    - docker compose -f tests/docker-compose.test.yml run meta
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - .cursorrules
        - skills/**/*
        - workflows/**/*
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Error handling tests (no tokens required)
test:error-handling:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker compose -f tests/docker-compose.test.yml build
    - docker compose -f tests/docker-compose.test.yml run error-handling
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - tests/integration/**/*
        - tools/pm/**/*
        - tools/agent/**/*
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Scenario tests (quick mode, core scenarios only)
test:scenario:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker compose -f tests/docker-compose.test.yml build
    - docker compose -f tests/docker-compose.test.yml run scenario
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - tests/scenario/**/*
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true  # Scenarios may skip due to missing tokens

# E2E tests (requires tokens, manual/scheduled only)
test:e2e:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    GITLAB_API_TOKEN: ${GITLAB_API_TOKEN}
    GITLAB_URL: ${GITLAB_URL}
    GITLAB_TEST_PROJECT: ${GITLAB_TEST_PROJECT}
    JIRA_API_TOKEN: ${JIRA_API_TOKEN}
    JIRA_URL: ${JIRA_URL}
    JIRA_EMAIL: ${JIRA_EMAIL}
    JIRA_TEST_PROJECT: ${JIRA_TEST_PROJECT}
  script:
    - docker compose -f tests/docker-compose.test.yml build
    - docker compose -f tests/docker-compose.test.yml run e2e
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - when: manual
  allow_failure: true  # E2E may fail due to external service issues

# Full scenario tests (all 15 scenarios, manual only)
test:scenario-full:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    GITLAB_API_TOKEN: ${GITLAB_API_TOKEN}
    GITLAB_URL: ${GITLAB_URL}
    GITHUB_TOKEN: ${GITHUB_TOKEN}
    JIRA_API_TOKEN: ${JIRA_API_TOKEN}
    JIRA_URL: ${JIRA_URL}
    JIRA_EMAIL: ${JIRA_EMAIL}
  script:
    - docker compose -f tests/docker-compose.test.yml build
    - docker compose -f tests/docker-compose.test.yml run scenario-full
  rules:
    - when: manual
  allow_failure: true

# Optional: Combined report generation
report:
  stage: report
  image: ${LINT_IMAGE}
  needs:
    - job: lint:c
      optional: true
    - job: lint:c:ai
      optional: true
    - job: lint:bash
      optional: true
    - job: lint:python
      optional: true
    - job: lint:make
      optional: true
    - job: lint:yaml
      optional: true
    - job: lint:whitespace
      optional: true
  script:
    - cd ${CI_PROJECT_DIR}
    - mkdir -p out
    - tools/lint/scripts/generate_report.sh > out/report.md || true
  artifacts:
    when: always
    paths:
      - out/report.md
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
