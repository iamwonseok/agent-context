# GitLab CI/CD Configuration
# agent-context repository
#
# Linting: Uses pre-commit (same as local development)
# Testing: Docker-based integration tests
#
---
stages:
  - lint
  - test

# =============================================================================
# Job Templates
# =============================================================================

.docker-test:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - docker compose -f tests/docker-compose.test.yml build

.rules-mr-or-main:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# Lint Stage
# =============================================================================

lint:
  stage: lint
  image: python:3.11-slim
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends curl ca-certificates
    - |
      if ! command -v hadolint >/dev/null 2>&1; then
        HADO_VER="v2.14.0"
        ARCH="$(dpkg --print-architecture)"
        case "${ARCH}" in
          amd64) BIN="hadolint-Linux-x86_64" ;;
          arm64) BIN="hadolint-Linux-aarch64" ;;
          *)
            echo "[X] Unsupported architecture for hadolint: ${ARCH}" >&2
            exit 1
            ;;
        esac
        curl -fsSL -o /usr/local/bin/hadolint \
          "https://github.com/hadolint/hadolint/releases/download/${HADO_VER}/${BIN}"
        chmod +x /usr/local/bin/hadolint
      fi
    - pip install pre-commit
  script:
    - pre-commit run --all-files --show-diff-on-failure
  rules:
    - !reference [.rules-mr-or-main, rules]

# =============================================================================
# Test Stage - Core Tests (Always Run)
# =============================================================================

# Workflow tests (Stage 0-2: unit, smoke, local-git)
# E2E tests (Stage 3) require API tokens and are run locally only
test:workflow:
  extends: .docker-test
  script:
    - docker compose -f tests/docker-compose.test.yml run unit
    - docker compose -f tests/docker-compose.test.yml run smoke
    - docker compose -f tests/docker-compose.test.yml run local-git
  rules:
    - !reference [.rules-mr-or-main, rules]

# =============================================================================
# Test Stage - Conditional Tests (Run on Specific Changes)
# =============================================================================

# Meta-validation tests (framework self-validation)
test:meta:
  extends: .docker-test
  script:
    - docker compose -f tests/docker-compose.test.yml run meta
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - .cursorrules
        - skills/**/*
        - workflows/**/*
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Error handling tests (no tokens required)
test:error-handling:
  extends: .docker-test
  script:
    - docker compose -f tests/docker-compose.test.yml run error-handling
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - tests/integration/**/*
        - tools/pm/**/*
        - tools/agent/**/*
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Scenario tests (quick mode, core scenarios only)
test:scenario:
  extends: .docker-test
  script:
    - docker compose -f tests/docker-compose.test.yml run scenario
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - tests/scenario/**/*
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true

# =============================================================================
# Test Stage - Manual/Scheduled Tests (Require Tokens)
# =============================================================================

# E2E tests (requires tokens, manual/scheduled only)
test:e2e:
  extends: .docker-test
  variables:
    DOCKER_TLS_CERTDIR: ""
    GITLAB_API_TOKEN: ${GITLAB_API_TOKEN}
    GITLAB_URL: ${GITLAB_URL}
    GITLAB_TEST_PROJECT: ${GITLAB_TEST_PROJECT}
    JIRA_API_TOKEN: ${JIRA_API_TOKEN}
    JIRA_URL: ${JIRA_URL}
    JIRA_EMAIL: ${JIRA_EMAIL}
    JIRA_TEST_PROJECT: ${JIRA_TEST_PROJECT}
  script:
    - docker compose -f tests/docker-compose.test.yml run e2e
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - when: manual
  allow_failure: true

# Full scenario tests (all 15 scenarios, manual only)
test:scenario-full:
  extends: .docker-test
  variables:
    DOCKER_TLS_CERTDIR: ""
    GITLAB_API_TOKEN: ${GITLAB_API_TOKEN}
    GITLAB_URL: ${GITLAB_URL}
    GITHUB_TOKEN: ${GITHUB_TOKEN}
    JIRA_API_TOKEN: ${JIRA_API_TOKEN}
    JIRA_URL: ${JIRA_URL}
    JIRA_EMAIL: ${JIRA_EMAIL}
  script:
    - docker compose -f tests/docker-compose.test.yml run scenario-full
  rules:
    - when: manual
  allow_failure: true
