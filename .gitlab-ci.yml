# GitLab CI/CD Configuration
# agent-context repository
#
# Linting: Uses pre-commit (same as local development)
#
# Pipeline stages:
#   lint  - Code quality checks (pre-commit)
#
---
default:
  tags:
    - soc-ip-fw-dind1

stages:
  - lint

# =============================================================================
# Global Variables
# =============================================================================
variables:
  # Shared across all jobs
  DOCKER_TLS_CERTDIR: ""

# =============================================================================
# Job Templates
# =============================================================================

.rules-mr-or-main:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# Lint Stage
# =============================================================================

lint:
  stage: lint
  image: python:3.11-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq git
    - |
      # hadolint is a standalone binary (not in apt or pip).
      # Download it if not already present for the pre-commit hadolint hook.
      set -e
      set -o pipefail

      CI_BIN_DIR="${CI_PROJECT_DIR}/.ci/bin"
      mkdir -p "${CI_BIN_DIR}"
      export PATH="${CI_BIN_DIR}:${PATH}"

      if ! command -v hadolint >/dev/null 2>&1; then
      	python3 - <<-'PY'
      	import os
      	import platform
      	import stat
      	import urllib.request

      	ver = "v2.14.0"
      	arch = platform.machine().lower()
      	if arch in ("x86_64", "amd64"):
      	    bin_name = "hadolint-Linux-x86_64"
      	elif arch in ("aarch64", "arm64"):
      	    bin_name = "hadolint-Linux-aarch64"
      	else:
      	    raise SystemExit(f"[X] Unsupported architecture for hadolint: {arch}")

      	dst_dir = os.path.join(os.environ["CI_PROJECT_DIR"], ".ci", "bin")
      	os.makedirs(dst_dir, exist_ok=True)
      	dst = os.path.join(dst_dir, "hadolint")
      	url = f"https://github.com/hadolint/hadolint/releases/download/{ver}/{bin_name}"

      	print(f"[*] Downloading hadolint: {url}")
      	with urllib.request.urlopen(url) as r:
      	    data = r.read()
      	with open(dst, "wb") as f:
      	    f.write(data)
      	st = os.stat(dst)
      	os.chmod(dst, st.st_mode | stat.S_IXUSR | stat.S_IXGRP | stat.S_IXOTH)
      	print(f"[V] Installed hadolint to: {dst}")
      	PY
      fi
    - pip install pre-commit
  script:
    - pre-commit run --all-files --show-diff-on-failure
  rules:
    - !reference [.rules-mr-or-main, rules]
