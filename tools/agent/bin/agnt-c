#!/bin/bash
# agnt-c - Agent Context Workflow CLI
# Developer and Manager workflow automation for AI-assisted development

set -e

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"
TEMPLATES_DIR="$(dirname "$SCRIPT_DIR")/templates"
PM_DIR="$(dirname "$(dirname "$SCRIPT_DIR")")/pm/bin"

# Source libraries
source "$LIB_DIR/parser.sh"
source "$LIB_DIR/roles.sh"
source "$LIB_DIR/git-strategy.sh"
source "$LIB_DIR/branch.sh"
source "$LIB_DIR/context.sh"
source "$LIB_DIR/handoff.sh"
source "$LIB_DIR/checks.sh"
source "$LIB_DIR/markdown.sh"
source "$LIB_DIR/upload.sh"
source "$LIB_DIR/permissions.sh"
source "$LIB_DIR/executor.sh"
source "$LIB_DIR/init.sh"
source "$LIB_DIR/manager.sh"
source "$LIB_DIR/setup.sh"
source "$LIB_DIR/bootstrap.sh"

# Version
VERSION="2.0.0"

# Help message
show_help() {
    cat << EOF
agnt-c - Agent Context Workflow CLI v${VERSION}

USAGE:
    agnt-c [role] <action> [options]

    Role can be omitted and will be auto-detected:
    - 'dev' for developer commands
    - 'mgr' for manager commands

DEVELOPER COMMANDS (agnt-c dev):
    start <task-id>         Start working on a task (create branch)
    start <task-id> --detached  Start in detached mode (worktree)
    list                    List active tasks (branches/worktrees)
    switch <branch>         Switch to another branch/worktree
    handoff <save|show>     Save/show handoff note for a branch
    status                  Show current work status
    debrief                 Process answered questions (RFC-004 Phase 2)
    check [options]         Run quality checks (lint, test, intent)
        --install-hook      Install pre-commit hook
        --uninstall-hook    Remove pre-commit hook
        --status            Show hook status
    verify                  Verify requirements and generate report
    retro                   Create/edit retrospective document
    sync                    Sync with base branch (fetch + rebase)
    submit [options]        Create MR and cleanup
        --only=<steps>      Run only: sync,push,pr,jira
        --skip=<steps>      Skip specified steps
        --draft             Create draft MR/PR
    cleanup <task-id>       Clean up completed task

MANAGER COMMANDS (agnt-c mgr):
    pending                 List pending MRs
    review <mr-id>          Review MR details
    approve <mr-id>         Approve MR
    status <id>             Check initiative/epic/task status

COMMON COMMANDS:
    help                    Show this help
    version                 Show version
    config show             Show configuration
    init                    Initialize project for agent workflow
    setup                   Install templates to project (idempotent)
    bootstrap [options]     Check/install tool dependencies
        --check             Check if tools are installed (default)
        --install           Install missing tools
        --lang=<langs>      Specify languages (c,cpp,python,shell,yaml,docker)

OPTIONS:
    -h, --help              Show this help
    -v, --version           Show version
    --detached              Use worktree mode (background work)
    --try=<name>            Name the try (for A/B testing)
    --from=<branch>         Branch to start from (default: main)

EXAMPLES:
    agnt-c dev start TASK-123
    agnt-c dev start TASK-123 --detached --try="approach-a"
    agnt-c dev list
    agnt-c dev submit
    agnt-c status
    agnt-c mgr pending

SHORTCUTS (without 'dev' prefix):
    agnt-c sync          # Same as: agnt-c dev sync
    agnt-c check         # Same as: agnt-c dev check
    agnt-c submit        # Same as: agnt-c dev submit
    agnt-c verify        # Same as: agnt-c dev verify
    agnt-c start TASK    # Same as: agnt-c dev start TASK

For more information, see: .agent/tools/agent/README.md
EOF
}

# Developer commands
cmd_dev() {
    local action="$1"
    shift || true

    case "$action" in
        start)
            dev_start "$@"
            ;;
        list)
            dev_list "$@"
            ;;
        switch)
            dev_switch "$@"
            ;;
        handoff)
            dev_handoff "$@"
            ;;
        status|"")
            dev_status "$@"
            ;;
        debrief)
            dev_debrief "$@"
            ;;
        check)
            dev_check "$@"
            ;;
        verify)
            dev_verify "$@"
            ;;
        retro)
            dev_retro "$@"
            ;;
        sync)
            dev_sync "$@"
            ;;
        submit)
            dev_submit "$@"
            ;;
        cleanup)
            dev_cleanup "$@"
            ;;
        help|--help|-h)
            show_dev_help
            ;;
        *)
            echo "[ERROR] Unknown dev command: $action" >&2
            echo "Run 'agnt-c dev help' for usage." >&2
            exit 1
            ;;
    esac
}

# Manager commands
cmd_mgr() {
    local action="$1"
    shift || true

    case "$action" in
        pending)
            mgr_pending "$@"
            ;;
        review)
            mgr_review "$@"
            ;;
        approve)
            mgr_approve "$@"
            ;;
        status)
            mgr_status "$@"
            ;;
        help|--help|-h)
            show_mgr_help
            ;;
        *)
            echo "[ERROR] Unknown mgr command: $action" >&2
            echo "Run 'agnt-c mgr help' for usage." >&2
            exit 1
            ;;
    esac
}

# Show current status (common command)
cmd_status() {
    echo "=================================================="
    echo "Agent Workflow Status"
    echo "=================================================="
    echo ""

    # Current directory info
    local project_root
    project_root=$(find_project_root 2>/dev/null) || true

    if [[ -z "$project_root" ]]; then
        echo "[WARN] Not in a git repository"
        return 1
    fi

    echo "Project Root: $project_root"
    echo ""

    # Git info
    echo "[Git]"
    local current_branch
    current_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null) || current_branch="(detached)"
    echo "  Current Branch: $current_branch"

    # Check if in worktree
    local git_dir
    git_dir=$(git rev-parse --git-dir 2>/dev/null)
    if [[ "$git_dir" == *".git/worktrees/"* ]]; then
        echo "  Mode: Detached (worktree)"
        echo "  Worktree: $(pwd)"
    else
        echo "  Mode: Interactive (branch)"
    fi
    echo ""

    # Context info
    echo "[Active Tasks]"
    list_active_contexts "$project_root"
    echo ""
    echo "=================================================="
}

# Show configuration
cmd_config() {
    local action="$1"
    case "$action" in
        show)
            show_agent_config
            ;;
        *)
            echo "[ERROR] Unknown config command: $action" >&2
            echo "Usage: agnt-c config show" >&2
            exit 1
            ;;
    esac
}

# Main entry point
main() {
    # No arguments - show help
    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi

    # Parse first argument
    local first_arg="$1"
    shift

    case "$first_arg" in
        -h|--help|help)
            show_help
            ;;
        -v|--version|version)
            echo "agnt-c version $VERSION"
            ;;
        dev)
            cmd_dev "$@"
            ;;
        mgr)
            cmd_mgr "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        config)
            cmd_config "$@"
            ;;
        init)
            agent_init "$@"
            ;;
        setup)
            agent_setup "$@"
            ;;
        bootstrap)
            agent_bootstrap "$@"
            ;;
        # Auto-detect role based on command (short aliases)
        start|list|switch|sync|check|submit|cleanup|verify|retro|handoff|debrief)
            # These are developer commands - can be called without 'dev' prefix
            cmd_dev "$first_arg" "$@"
            ;;
        pending|review|approve)
            # These are manager commands
            cmd_mgr "$first_arg" "$@"
            ;;
        *)
            echo "[ERROR] Unknown command: $first_arg" >&2
            echo "Run 'agnt-c --help' for usage." >&2
            exit 1
            ;;
    esac
}

main "$@"
