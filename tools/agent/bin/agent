#!/bin/bash
# Agent Workflow CLI
# Developer and Manager workflow automation for AI-assisted development

set -e

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"
TEMPLATES_DIR="$(dirname "$SCRIPT_DIR")/templates"
PM_DIR="$(dirname "$(dirname "$SCRIPT_DIR")")/pm/bin"

# Source libraries
source "$LIB_DIR/parser.sh"
source "$LIB_DIR/roles.sh"
source "$LIB_DIR/git-strategy.sh"
source "$LIB_DIR/branch.sh"
source "$LIB_DIR/context.sh"
source "$LIB_DIR/checks.sh"
source "$LIB_DIR/markdown.sh"
source "$LIB_DIR/upload.sh"
source "$LIB_DIR/permissions.sh"
source "$LIB_DIR/executor.sh"
source "$LIB_DIR/init.sh"
source "$LIB_DIR/manager.sh"

# Version
VERSION="0.1.0"

# Help message
show_help() {
    cat << EOF
agent - Workflow CLI v${VERSION}

USAGE:
    agent [role] <action> [options]

    Role can be omitted and will be auto-detected:
    - 'dev' for developer commands
    - 'mgr' for manager commands

DEVELOPER COMMANDS (agent dev):
    start <task-id>         Start working on a task (create branch)
    start <task-id> --detached  Start in detached mode (worktree)
    list                    List active tasks (branches/worktrees)
    switch <branch>         Switch to another branch/worktree
    status                  Show current work status
    check                   Run quality checks (lint, test, intent)
    verify                  Verify requirements and generate report
    retro                   Create/edit retrospective document
    sync                    Sync with base branch (fetch + rebase)
    submit                  Create MR and cleanup
    cleanup <task-id>       Clean up completed task

MANAGER COMMANDS (agent mgr):
    pending                 List pending MRs
    review <mr-id>          Review MR details
    approve <mr-id>         Approve MR
    status <id>             Check initiative/epic/task status

COMMON COMMANDS:
    help                    Show this help
    version                 Show version
    config show             Show configuration
    init                    Initialize project for agent workflow

OPTIONS:
    -h, --help              Show this help
    -v, --version           Show version
    --detached              Use worktree mode (background work)
    --try=<name>            Name the try (for A/B testing)
    --from=<branch>         Branch to start from (default: main)

EXAMPLES:
    agent dev start TASK-123
    agent dev start TASK-123 --detached --try="approach-a"
    agent dev list
    agent dev submit
    agent status
    agent mgr pending

For more information, see: .agent/tools/agent/README.md
EOF
}

# Developer commands
cmd_dev() {
    local action="$1"
    shift || true

    case "$action" in
        start)
            dev_start "$@"
            ;;
        list)
            dev_list "$@"
            ;;
        switch)
            dev_switch "$@"
            ;;
        status|"")
            dev_status "$@"
            ;;
        check)
            dev_check "$@"
            ;;
        verify)
            dev_verify "$@"
            ;;
        retro)
            dev_retro "$@"
            ;;
        sync)
            dev_sync "$@"
            ;;
        submit)
            dev_submit "$@"
            ;;
        cleanup)
            dev_cleanup "$@"
            ;;
        help|--help|-h)
            show_dev_help
            ;;
        *)
            echo "[ERROR] Unknown dev command: $action" >&2
            echo "Run 'agent dev help' for usage." >&2
            exit 1
            ;;
    esac
}

# Manager commands
cmd_mgr() {
    local action="$1"
    shift || true

    case "$action" in
        pending)
            mgr_pending "$@"
            ;;
        review)
            mgr_review "$@"
            ;;
        approve)
            mgr_approve "$@"
            ;;
        status)
            mgr_status "$@"
            ;;
        help|--help|-h)
            show_mgr_help
            ;;
        *)
            echo "[ERROR] Unknown mgr command: $action" >&2
            echo "Run 'agent mgr help' for usage." >&2
            exit 1
            ;;
    esac
}

# Show current status (common command)
cmd_status() {
    echo "=================================================="
    echo "Agent Workflow Status"
    echo "=================================================="
    echo ""

    # Current directory info
    local project_root
    project_root=$(find_project_root 2>/dev/null) || true

    if [[ -z "$project_root" ]]; then
        echo "[WARN] Not in a git repository"
        return 1
    fi

    echo "Project Root: $project_root"
    echo ""

    # Git info
    echo "[Git]"
    local current_branch
    current_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null) || current_branch="(detached)"
    echo "  Current Branch: $current_branch"

    # Check if in worktree
    local git_dir
    git_dir=$(git rev-parse --git-dir 2>/dev/null)
    if [[ "$git_dir" == *".git/worktrees/"* ]]; then
        echo "  Mode: Detached (worktree)"
        echo "  Worktree: $(pwd)"
    else
        echo "  Mode: Interactive (branch)"
    fi
    echo ""

    # Context info
    echo "[Active Tasks]"
    list_active_contexts "$project_root"
    echo ""
    echo "=================================================="
}

# Show configuration
cmd_config() {
    local action="$1"
    case "$action" in
        show)
            show_agent_config
            ;;
        *)
            echo "[ERROR] Unknown config command: $action" >&2
            echo "Usage: agent config show" >&2
            exit 1
            ;;
    esac
}

# Main entry point
main() {
    # No arguments - show help
    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi

    # Parse first argument
    local first_arg="$1"
    shift

    case "$first_arg" in
        -h|--help|help)
            show_help
            ;;
        -v|--version|version)
            echo "agent version $VERSION"
            ;;
        dev)
            cmd_dev "$@"
            ;;
        mgr)
            cmd_mgr "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        config)
            cmd_config "$@"
            ;;
        init)
            agent_init "$@"
            ;;
        # Auto-detect role based on command
        start|list|switch|sync|submit|cleanup)
            # These are developer commands
            cmd_dev "$first_arg" "$@"
            ;;
        pending|review|approve)
            # These are manager commands
            cmd_mgr "$first_arg" "$@"
            ;;
        *)
            echo "[ERROR] Unknown command: $first_arg" >&2
            echo "Run 'agent --help' for usage." >&2
            exit 1
            ;;
    esac
}

main "$@"
