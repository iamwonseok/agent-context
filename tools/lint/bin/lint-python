#!/bin/bash
# lint-python - Python Coding Convention Checker
#
# Usage: lint-python [OPTIONS] [PATH]
#   --external-only   External tools only (flake8, black)
#   --regex-only      Regex rules only (original behavior)
#   --check-tools     Show tool availability

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "${SCRIPT_DIR}/../scripts/rules/python_rules.sh"
source "${SCRIPT_DIR}/../lib/executor.sh"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

RECURSIVE=false
JUNIT_OUTPUT=false
JUNIT_FILE=""
QUIET=false
TARGET="."
MODE="hybrid"

POSITIONAL=()
while [[ $# -gt 0 ]]; do
	case $1 in
		-R|--recursive) RECURSIVE=true; shift ;;
		--junit) JUNIT_OUTPUT=true; shift ;;
		-o|--output) JUNIT_FILE="$2"; shift 2 ;;
		-q|--quiet) QUIET=true; shift ;;
		--external-only) MODE="external"; shift ;;
		--regex-only) MODE="regex"; shift ;;
		--check-tools) check_tools_status python; exit 0 ;;
		-h|--help)
			echo "Usage: lint-python [OPTIONS] [PATH]"
			echo ""
			echo "Check Python files for coding convention violations."
			echo ""
			echo "Options:"
			echo "  -R, --recursive      Check directories recursively"
			echo "  --junit              Output JUnit XML format"
			echo "  -o, --output FILE    Write output to file"
			echo "  -q, --quiet          Quiet mode"
			echo "  --external-only      Use external tools only (flake8, black)"
			echo "  --regex-only         Use regex rules only"
			echo "  --check-tools        Show tool availability"
			echo "  -h, --help           Show this help"
			exit 0
			;;
		-*) echo "Unknown option: $1" >&2; exit 1 ;;
		*) POSITIONAL+=("$1"); shift ;;
	esac
done

[[ ${#POSITIONAL[@]} -gt 0 ]] && TARGET="${POSITIONAL[0]}"

FILES=()
if [[ -f "${TARGET}" ]]; then
	FILES=("${TARGET}")
elif [[ -d "${TARGET}" ]]; then
	if [[ "${RECURSIVE}" == true ]]; then
		while IFS= read -r -d '' file; do
			FILES+=("${file}")
		done < <(find "${TARGET}" -type f -name "*.py" -print0 2>/dev/null)
	else
		for file in "${TARGET}"/*.py; do
			[[ -f "${file}" ]] && FILES+=("${file}")
		done
	fi
else
	echo -e "${RED}Error: ${TARGET} not found${NC}" >&2
	exit 1
fi

if [[ ${#FILES[@]} -eq 0 ]]; then
	echo -e "${YELLOW}No Python files found${NC}" >&2
	exit 0
fi

# Find configuration files
FLAKE8_CONFIG=$(find_config ".flake8" "$(pwd)") || true
PYPROJECT_CONFIG=$(find_config "pyproject.toml" "$(pwd)") || true

PASS_COUNT=0
FAIL_COUNT=0
TEST_CASES=""

if [[ "${QUIET}" == false && "${JUNIT_OUTPUT}" == false ]]; then
	echo -e "${BOLD}${CYAN}Checking ${#FILES[@]} Python file(s)...${NC}"
	echo -e "${DIM}Mode: ${MODE}${NC}"
	[[ -n "${FLAKE8_CONFIG}" ]] && echo -e "${DIM}flake8 config: ${FLAKE8_CONFIG}${NC}"
	[[ -n "${PYPROJECT_CONFIG}" ]] && echo -e "${DIM}black config: ${PYPROJECT_CONFIG}${NC}"
	echo ""
fi

for file in "${FILES[@]}"; do
	filename=$(basename "${file}")
	file_failed=false
	file_errors=""

	# 1st Pass: External tools
	if [[ "${MODE}" == "hybrid" || "${MODE}" == "external" ]]; then
		if run_flake8 "${file}" "${FLAKE8_CONFIG}"; then
			:
		elif [[ $? -ne 127 ]]; then
			file_failed=true
			file_errors+="[flake8] ${TOOL_OUTPUT}"$'\n'
		fi

		if run_black "${file}" "${PYPROJECT_CONFIG}"; then
			:
		elif [[ $? -ne 127 ]]; then
			file_failed=true
			file_errors+="[black] ${TOOL_OUTPUT}"$'\n'
		fi
	fi

	# 2nd Pass: Regex rules
	if [[ "${MODE}" == "hybrid" || "${MODE}" == "regex" ]]; then
		if ! check_python_file "${file}"; then
			file_failed=true
			file_errors+="[regex] ${CHECK_RESULT}"$'\n'
		fi
	fi

	if [[ "${file_failed}" == false ]]; then
		PASS_COUNT=$((PASS_COUNT + 1))
		[[ "${QUIET}" == false && "${JUNIT_OUTPUT}" == false ]] && echo -e "${GREEN}[PASS]${NC} ${file}"
		[[ "${JUNIT_OUTPUT}" == true ]] && TEST_CASES+="    <testcase classname=\"python.lint\" name=\"${filename}\" time=\"0.01\"/>"$'\n'
	else
		FAIL_COUNT=$((FAIL_COUNT + 1))
		if [[ "${JUNIT_OUTPUT}" == false ]]; then
			echo -e "${RED}[FAIL]${NC} ${file}"
			echo -e "${DIM}${file_errors}${NC}"
		else
			TEST_CASES+="    <testcase classname=\"python.lint\" name=\"${filename}\" time=\"0.01\"><failure message=\"Lint error\"><![CDATA[${file_errors}]]></failure></testcase>"$'\n'
		fi
	fi
done

TOTAL=$((PASS_COUNT + FAIL_COUNT))

if [[ "${JUNIT_OUTPUT}" == true ]]; then
	junit_output="<?xml version=\"1.0\" encoding=\"UTF-8\"?>
<testsuites>
  <testsuite name=\"CodingConvention.Python\" tests=\"${TOTAL}\" failures=\"${FAIL_COUNT}\" errors=\"0\" timestamp=\"$(date -Iseconds)\" time=\"1\">
${TEST_CASES}  </testsuite>
</testsuites>"
	[[ -n "${JUNIT_FILE}" ]] && echo "${junit_output}" > "${JUNIT_FILE}" && echo -e "${GREEN}Written to ${JUNIT_FILE}${NC}" >&2 || echo "${junit_output}"
else
	echo -e "\n${BOLD}========================================${NC}"
	echo -e "${BOLD}Python Lint Summary${NC}"
	echo -e "${BOLD}========================================${NC}"
	echo -e "Total: ${TOTAL} | ${GREEN}Passed: ${PASS_COUNT}${NC} | ${RED}Failed: ${FAIL_COUNT}${NC}"
fi

[[ ${FAIL_COUNT} -eq 0 ]]
