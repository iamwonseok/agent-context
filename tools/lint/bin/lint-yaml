#!/bin/bash
# lint-yaml - YAML/Dockerfile Coding Convention Checker
#
# Usage: lint-yaml [OPTIONS] [PATH]
#   --external-only   External tools only (yamllint, hadolint)
#   --regex-only      Regex rules only (original behavior)
#   --check-tools     Show tool availability

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "${SCRIPT_DIR}/../scripts/rules/yaml_rules.sh"
source "${SCRIPT_DIR}/../lib/executor.sh"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

RECURSIVE=false
JUNIT_OUTPUT=false
JUNIT_FILE=""
QUIET=false
TARGET="."
MODE="hybrid"

POSITIONAL=()
while [[ $# -gt 0 ]]; do
	case $1 in
		-R|--recursive) RECURSIVE=true; shift ;;
		--junit) JUNIT_OUTPUT=true; shift ;;
		-o|--output) JUNIT_FILE="$2"; shift 2 ;;
		-q|--quiet) QUIET=true; shift ;;
		--external-only) MODE="external"; shift ;;
		--regex-only) MODE="regex"; shift ;;
		--check-tools) check_tools_status yaml; check_tools_status docker; exit 0 ;;
		-h|--help)
			echo "Usage: lint-yaml [OPTIONS] [PATH]"
			echo ""
			echo "Check YAML and Dockerfile for coding convention violations."
			echo ""
			echo "Options:"
			echo "  -R, --recursive      Check directories recursively"
			echo "  --junit              Output JUnit XML format"
			echo "  -o, --output FILE    Write output to file"
			echo "  -q, --quiet          Quiet mode"
			echo "  --external-only      Use external tools only (yamllint, hadolint)"
			echo "  --regex-only         Use regex rules only"
			echo "  --check-tools        Show tool availability"
			echo "  -h, --help           Show this help"
			exit 0
			;;
		-*) echo "Unknown option: $1" >&2; exit 1 ;;
		*) POSITIONAL+=("$1"); shift ;;
	esac
done

[[ ${#POSITIONAL[@]} -gt 0 ]] && TARGET="${POSITIONAL[0]}"

FILES=()
if [[ -f "${TARGET}" ]]; then
	FILES=("${TARGET}")
elif [[ -d "${TARGET}" ]]; then
	if [[ "${RECURSIVE}" == true ]]; then
		while IFS= read -r -d '' file; do
			FILES+=("${file}")
		done < <(find "${TARGET}" -type f \( -name "*.yaml" -o -name "*.yml" -o -name "Dockerfile" -o -name "*.Dockerfile" \) -print0 2>/dev/null)
	else
		for file in "${TARGET}"/*.yaml "${TARGET}"/*.yml "${TARGET}"/Dockerfile "${TARGET}"/*.Dockerfile; do
			[[ -f "${file}" ]] && FILES+=("${file}")
		done
	fi
else
	echo -e "${RED}Error: ${TARGET} not found${NC}" >&2
	exit 1
fi

if [[ ${#FILES[@]} -eq 0 ]]; then
	echo -e "${YELLOW}No YAML/Dockerfile found${NC}" >&2
	exit 0
fi

# Find configuration files
YAMLLINT_CONFIG=$(find_config ".yamllint.yml" "$(pwd)") || true
HADOLINT_CONFIG=$(find_config ".hadolint.yaml" "$(pwd)") || true

PASS_COUNT=0
FAIL_COUNT=0
TEST_CASES=""

if [[ "${QUIET}" == false && "${JUNIT_OUTPUT}" == false ]]; then
	echo -e "${BOLD}${CYAN}Checking ${#FILES[@]} file(s)...${NC}"
	echo -e "${DIM}Mode: ${MODE}${NC}"
	[[ -n "${YAMLLINT_CONFIG}" ]] && echo -e "${DIM}yamllint config: ${YAMLLINT_CONFIG}${NC}"
	[[ -n "${HADOLINT_CONFIG}" ]] && echo -e "${DIM}hadolint config: ${HADOLINT_CONFIG}${NC}"
	echo ""
fi

for file in "${FILES[@]}"; do
	filename=$(basename "${file}")
	file_failed=false
	file_errors=""

	# Determine check function and external tool based on file type
	if [[ "${file}" == *Dockerfile* ]]; then
		check_func="check_dockerfile_file"
		classname="dockerfile.lint"
		external_func="run_hadolint"
		external_config="${HADOLINT_CONFIG}"
		tool_name="hadolint"
	else
		check_func="check_yaml_file"
		classname="yaml.lint"
		external_func="run_yamllint"
		external_config="${YAMLLINT_CONFIG}"
		tool_name="yamllint"
	fi

	# 1st Pass: External tools
	if [[ "${MODE}" == "hybrid" || "${MODE}" == "external" ]]; then
		if ${external_func} "${file}" "${external_config}"; then
			:
		elif [[ $? -ne 127 ]]; then
			file_failed=true
			file_errors+="[${tool_name}] ${TOOL_OUTPUT}"$'\n'
		fi
	fi

	# 2nd Pass: Regex rules
	if [[ "${MODE}" == "hybrid" || "${MODE}" == "regex" ]]; then
		if ! ${check_func} "${file}"; then
			file_failed=true
			file_errors+="[regex] ${CHECK_RESULT}"$'\n'
		fi
	fi

	if [[ "${file_failed}" == false ]]; then
		PASS_COUNT=$((PASS_COUNT + 1))
		[[ "${QUIET}" == false && "${JUNIT_OUTPUT}" == false ]] && echo -e "${GREEN}[PASS]${NC} ${file}"
		[[ "${JUNIT_OUTPUT}" == true ]] && TEST_CASES+="    <testcase classname=\"${classname}\" name=\"${filename}\" time=\"0.01\"/>"$'\n'
	else
		FAIL_COUNT=$((FAIL_COUNT + 1))
		if [[ "${JUNIT_OUTPUT}" == false ]]; then
			echo -e "${RED}[FAIL]${NC} ${file}"
			echo -e "${DIM}${file_errors}${NC}"
		else
			TEST_CASES+="    <testcase classname=\"${classname}\" name=\"${filename}\" time=\"0.01\"><failure message=\"Lint error\"><![CDATA[${file_errors}]]></failure></testcase>"$'\n'
		fi
	fi
done

TOTAL=$((PASS_COUNT + FAIL_COUNT))

if [[ "${JUNIT_OUTPUT}" == true ]]; then
	junit_output="<?xml version=\"1.0\" encoding=\"UTF-8\"?>
<testsuites>
  <testsuite name=\"CodingConvention.YAML\" tests=\"${TOTAL}\" failures=\"${FAIL_COUNT}\" errors=\"0\" timestamp=\"$(date -Iseconds)\" time=\"1\">
${TEST_CASES}  </testsuite>
</testsuites>"
	[[ -n "${JUNIT_FILE}" ]] && echo "${junit_output}" > "${JUNIT_FILE}" && echo -e "${GREEN}Written to ${JUNIT_FILE}${NC}" >&2 || echo "${junit_output}"
else
	echo -e "\n${BOLD}========================================${NC}"
	echo -e "${BOLD}YAML/Dockerfile Lint Summary${NC}"
	echo -e "${BOLD}========================================${NC}"
	echo -e "Total: ${TOTAL} | ${GREEN}Passed: ${PASS_COUNT}${NC} | ${RED}Failed: ${FAIL_COUNT}${NC}"
fi

[[ ${FAIL_COUNT} -eq 0 ]]
