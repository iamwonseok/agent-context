#!/bin/bash
# Project Management CLI
# JIRA/Confluence integration for development workflows
#
# For GitLab: use glab CLI (https://gitlab.com/gitlab-org/cli)
# For GitHub: use gh CLI (https://cli.github.com)

set -e

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"

# Source libraries
source "$LIB_DIR/config.sh"
source "$LIB_DIR/jira.sh"
source "$LIB_DIR/confluence.sh"
source "$LIB_DIR/export.sh"

# Version
VERSION="2.0.0"

# Help message
show_help() {
    cat << EOF
pm - Project Management CLI v${VERSION}

USAGE:
    pm <command> [options]

COMMANDS:
    config show             Show current configuration
    config init             Create .project.yaml

    jira me                 Show current Jira user
    jira user search QUERY  Search users by email/name
    jira issue list         List Jira issues
    jira issue view KEY     View issue details
    jira issue create TITLE Create new issue
    jira issue assign KEY EMAIL  Assign issue to user
    jira issue update KEY [OPTIONS]  Update issue fields
    jira issue transition KEY STATUS  Transition issue status
    jira sprint list [BOARD_ID]  List sprints
    jira sprint move KEY SPRINT_ID  Move issue to sprint
    jira workflow list      List workflows
    jira workflow transitions KEY  Show available transitions
    jira workflow statuses  List all statuses
    jira link types         List available link types
    jira link view KEY      View issue links (dependencies)
    jira link create FROM TO TYPE  Create link (e.g., "Blocks")
    jira link delete LINK_ID  Delete link
    jira bulk-create --csv FILE  Bulk create issues from CSV
    jira export             Export issues to Markdown files

    confluence me           Show current Confluence user
    confluence space list   List spaces
    confluence space view KEY  View space details
    confluence space create --key KEY --name NAME  Create space
    confluence space permissions KEY  View space permissions
    confluence space delete KEY --force  Delete space (dangerous!)
    confluence page list    List pages in space
    confluence page view ID View page details
    confluence page text ID View page as plain text
    confluence page create  Create new page
    confluence search CQL   Search pages
    confluence export       Export pages to Markdown files

OPTIONS:
    -h, --help              Show this help
    -v, --version           Show version

EXAMPLES:
    pm config show
    pm jira issue list
    pm jira issue create "Add UART driver"
    pm confluence page list --space PROJ

NOTE:
    For GitLab operations, use: glab (https://gitlab.com/gitlab-org/cli)
    For GitHub operations, use: gh (https://cli.github.com)

For more information, see: tools/pm/README.md
EOF
}

# Parse arguments
cmd_config() {
    case "$1" in
        show)
            load_config || exit 1
            print_config
            ;;
        init)
            local force=false
            shift
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    -f|--force) force=true ;;
                esac
                shift
            done

            if [[ -f ".project.yaml" ]] && [[ "$force" != "true" ]]; then
                echo "[ERROR] .project.yaml already exists. Use --force to overwrite." >&2
                exit 1
            fi
            create_default_config ".project.yaml"
            ;;
        *)
            echo "[ERROR] Unknown config command: $1" >&2
            echo "Usage: pm config <show|init>" >&2
            exit 1
            ;;
    esac
}

cmd_jira() {
    load_config || exit 1

    case "$1" in
        me)
            jira_me
            ;;
        user)
            shift
            case "$1" in
                search)
                    shift
                    local query=""
                    if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                        query="$1"
                        shift
                    fi
                    jira_user_search "$query"
                    ;;
                *)
                    echo "[ERROR] Unknown jira user command: $1" >&2
                    echo "Usage: pm jira user <search>" >&2
                    exit 1
                    ;;
            esac
            ;;
        issue)
            shift
            case "$1" in
                list)
                    shift
                    local jql=""
                    local limit=20
                    while [[ $# -gt 0 ]]; do
                        case "$1" in
                            --jql) jql="$2"; shift ;;
                            -n|--limit) limit="$2"; shift ;;
                        esac
                        shift
                    done
                    jira_issue_list "$jql" "$limit"
                    ;;
                view)
                    jira_issue_view "$2"
                    ;;
                create)
                    shift
                    local summary=""
                    local type="Task"
                    local description=""

                    if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                        summary="$1"
                        shift
                    fi

                    while [[ $# -gt 0 ]]; do
                        case "$1" in
                            -t|--type) type="$2"; shift ;;
                            -d|--description) description="$2"; shift ;;
                        esac
                        shift
                    done

                    jira_issue_create "$summary" "$type" "$description"
                    ;;
                assign)
                    shift
                    local key=""
                    local assignee=""

                    if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                        key="$1"
                        shift
                    fi

                    if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                        assignee="$1"
                        shift
                    fi

                    jira_issue_assign "$key" "$assignee"
                    ;;
                transition)
                    shift
                    local key=""
                    local status=""

                    if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                        key="$1"
                        shift
                    fi

                    if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                        status="$1"
                        shift
                    fi

                    jira_transition "$key" "$status"
                    ;;
                update)
                    shift
                    local key=""

                    if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                        key="$1"
                        shift
                    fi

                    jira_issue_update "$key" "$@"
                    ;;
                comment)
                    shift
                    local comment_cmd="${1:-}"
                    shift || true

                    case "$comment_cmd" in
                        add)
                            local key=""
                            local text=""

                            # Parse: pm jira issue comment add KEY "text"
                            if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                                key="$1"
                                shift
                            fi
                            if [[ -n "$1" ]]; then
                                text="$1"
                            fi

                            if [[ -z "$key" ]] || [[ -z "$text" ]]; then
                                echo "[ERROR] Usage: pm jira issue comment add <KEY> <TEXT>" >&2
                                exit 1
                            fi

                            jira_issue_comment_add "$key" "$text"
                            ;;
                        list)
                            local key=""
                            if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                                key="$1"
                            fi

                            if [[ -z "$key" ]]; then
                                echo "[ERROR] Usage: pm jira issue comment list <KEY>" >&2
                                exit 1
                            fi

                            jira_issue_comment_list "$key"
                            ;;
                        *)
                            echo "[ERROR] Unknown comment command: $comment_cmd" >&2
                            echo "Usage: pm jira issue comment <add|list>" >&2
                            exit 1
                            ;;
                    esac
                    ;;
                *)
                    echo "[ERROR] Unknown jira issue command: $1" >&2
                    echo "Usage: pm jira issue <list|view|create|assign|update|transition|comment>" >&2
                    exit 1
                    ;;
            esac
            ;;
        sprint)
            shift
            case "$1" in
                list)
                    shift
                    local board_id=""
                    if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                        board_id="$1"
                    fi
                    jira_sprint_list "$board_id"
                    ;;
                move)
                    shift
                    local key=""
                    local sprint_id=""

                    if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                        key="$1"
                        shift
                    fi

                    if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                        sprint_id="$1"
                        shift
                    fi

                    jira_issue_move_to_sprint "$key" "$sprint_id"
                    ;;
                *)
                    echo "[ERROR] Unknown jira sprint command: $1" >&2
                    echo "Usage: pm jira sprint <list|move>" >&2
                    exit 1
                    ;;
            esac
            ;;
        workflow)
            shift
            case "$1" in
                list)
                    jira_workflow_list
                    ;;
                transitions)
                    shift
                    local key=""
                    if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                        key="$1"
                    fi
                    jira_workflow_transitions "$key"
                    ;;
                statuses)
                    jira_workflow_statuses
                    ;;
                *)
                    echo "[ERROR] Unknown jira workflow command: $1" >&2
                    echo "Usage: pm jira workflow <list|transitions|statuses>" >&2
                    exit 1
                    ;;
            esac
            ;;
        link)
            shift
            case "$1" in
                types)
                    jira_link_types
                    ;;
                view)
                    shift
                    local key=""
                    if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                        key="$1"
                    fi
                    jira_issue_links "$key"
                    ;;
                create)
                    shift
                    local from_key=""
                    local to_key=""
                    local link_type=""

                    if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                        from_key="$1"
                        shift
                    fi

                    if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                        to_key="$1"
                        shift
                    fi

                    if [[ -n "$1" ]]; then
                        link_type="$1"
                    fi

                    jira_link_create "$from_key" "$to_key" "$link_type"
                    ;;
                delete)
                    shift
                    local link_id=""
                    if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                        link_id="$1"
                    fi
                    jira_link_delete "$link_id"
                    ;;
                *)
                    echo "[ERROR] Unknown jira link command: $1" >&2
                    echo "Usage: pm jira link <types|view|create|delete>" >&2
                    exit 1
                    ;;
            esac
            ;;
        bulk-create)
            shift
            local csv_file=""

            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --csv) csv_file="$2"; shift ;;
                    *)
                        if [[ -z "$csv_file" ]]; then
                            csv_file="$1"
                        fi
                        ;;
                esac
                shift
            done

            jira_bulk_create "$csv_file"
            ;;
        export)
            shift
            local project=""
            local jql=""
            local output="./export/jira"
            local include_comments="false"
            local limit=1000

            while [[ $# -gt 0 ]]; do
                case "$1" in
                    -p|--project) project="$2"; shift ;;
                    --jql) jql="$2"; shift ;;
                    -o|--output) output="$2"; shift ;;
                    --include-comments) include_comments="true" ;;
                    -n|--limit) limit="$2"; shift ;;
                esac
                shift
            done

            jira_export "$project" "$jql" "$output" "$include_comments" "$limit"
            ;;
        *)
            echo "[ERROR] Unknown jira command: $1" >&2
            echo "Usage: pm jira <me|user|issue|sprint|workflow|link|bulk-create|export>" >&2
            exit 1
            ;;
    esac
}

cmd_confluence() {
    load_config || exit 1

    case "$1" in
        me)
            confluence_me
            ;;
        space)
            shift
            case "$1" in
                list)
                    shift
                    local limit=25
                    local list_all=false
                    while [[ $# -gt 0 ]]; do
                        case "$1" in
                            -n|--limit) limit="$2"; shift ;;
                            --all) list_all=true ;;
                        esac
                        shift
                    done
                    if [[ "${list_all}" == "true" ]]; then
                        confluence_space_list "$limit"
                    else
                        confluence_space_list_configured "$CONFLUENCE_SPACE_KEY"
                    fi
                    ;;
                view)
                    shift
                    local key=""
                    if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                        key="$1"
                    fi
                    confluence_space_view "$key"
                    ;;
                create)
                    shift
                    local key=""
                    local name=""
                    local description=""

                    while [[ $# -gt 0 ]]; do
                        case "$1" in
                            -k|--key) key="$2"; shift ;;
                            -n|--name) name="$2"; shift ;;
                            -d|--description) description="$2"; shift ;;
                        esac
                        shift
                    done

                    confluence_space_create "$key" "$name" "$description"
                    ;;
                permissions)
                    shift
                    local key=""
                    if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                        key="$1"
                    fi
                    confluence_space_permissions "$key"
                    ;;
                delete)
                    shift
                    local key=""
                    local force=""

                    if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                        key="$1"
                        shift
                    fi

                    if [[ "$1" == "--force" ]]; then
                        force="--force"
                    fi

                    confluence_space_delete "$key" "$force"
                    ;;
                *)
                    echo "[ERROR] Unknown confluence space command: $1" >&2
                    echo "Usage: pm confluence space <list|view|create|permissions|delete>" >&2
                    exit 1
                    ;;
            esac
            ;;
        page)
            shift
            case "$1" in
                list)
                    shift
                    local space=""
                    local limit=25
                    while [[ $# -gt 0 ]]; do
                        case "$1" in
                            -s|--space) space="$2"; shift ;;
                            -n|--limit) limit="$2"; shift ;;
                        esac
                        shift
                    done
                    confluence_page_list "$space" "$limit"
                    ;;
                view)
                    confluence_page_view "$2"
                    ;;
                text)
                    confluence_page_text "$2"
                    ;;
                create)
                    shift
                    local space=""
                    local title=""
                    local content=""
                    local parent=""

                    while [[ $# -gt 0 ]]; do
                        case "$1" in
                            -s|--space) space="$2"; shift ;;
                            -t|--title) title="$2"; shift ;;
                            -c|--content) content="$2"; shift ;;
                            -p|--parent) parent="$2"; shift ;;
                        esac
                        shift
                    done

                    if [[ -z "$title" ]]; then
                        echo "[ERROR] --title required" >&2
                        exit 1
                    fi

                    confluence_page_create "$space" "$title" "$content" "$parent"
                    ;;
                *)
                    echo "[ERROR] Unknown confluence page command: $1" >&2
                    echo "Usage: pm confluence page <list|view|text|create>" >&2
                    exit 1
                    ;;
            esac
            ;;
        search)
            shift
            local cql=""
            local limit=25

            if [[ -n "$1" ]] && [[ "$1" != -* ]]; then
                cql="$1"
                shift
            fi

            while [[ $# -gt 0 ]]; do
                case "$1" in
                    -n|--limit) limit="$2"; shift ;;
                esac
                shift
            done

            confluence_search "$cql" "$limit"
            ;;
        export)
            shift
            local space=""
            local output="./export/confluence"
            local preserve_hierarchy="false"
            local limit=1000

            while [[ $# -gt 0 ]]; do
                case "$1" in
                    -s|--space) space="$2"; shift ;;
                    -o|--output) output="$2"; shift ;;
                    --preserve-hierarchy) preserve_hierarchy="true" ;;
                    -n|--limit) limit="$2"; shift ;;
                esac
                shift
            done

            confluence_export "$space" "$output" "$preserve_hierarchy" "$limit"
            ;;
        *)
            echo "[ERROR] Unknown confluence command: $1" >&2
            echo "Usage: pm confluence <me|space|page|search|export>" >&2
            exit 1
            ;;
    esac
}

# Main
main() {
    case "$1" in
        -h|--help|help|"")
            show_help
            ;;
        -v|--version)
            echo "pm version $VERSION"
            ;;
        config)
            shift
            cmd_config "$@"
            ;;
        jira)
            shift
            cmd_jira "$@"
            ;;
        confluence)
            shift
            cmd_confluence "$@"
            ;;
        *)
            echo "[ERROR] Unknown command: $1" >&2
            echo "Run 'pm --help' for usage." >&2
            exit 1
            ;;
    esac
}

main "$@"
